# Analiza Raportu CodeRabbit

Poni偶ej znajduje si szczeg贸owa analiza bd贸w i sugestii zgoszonych przez CodeRabbit, przetumaczona na jzyk polski i odniesiona do specyfikacji projektu ([specyfikacja.md](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/specyfikacja.md)).

##  Krytyczne / Bezpieczestwo

### 1. Podatno na ataki czasowe (Timing Attacks) w Basic Auth
*   **Plik:** [app/middleware.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/middleware.ts) (linie 39-44)
*   **Problem:** Por贸wnywanie hase za pomoc zwykego operatora `===` pozwala na ataki typu "timing attack" (mo偶liwo odgadnicia hasa na podstawie czasu odpowiedzi).
*   **Wpyw:** Bezpieczestwo panelu administracyjnego (jeli istnieje, cho specyfikacja m贸wi o braku admina, kod ten istnieje).
*   **Rekomendacja:** U偶ycie bezpiecznej funkcji por贸wnujcej, np. `crypto.timingSafeEqual`.

### 2. Bdne obliczanie sygnatury P24 (Escaping)
*   **Plik:** [app/api/payments/create/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/payments/create/route.ts) (linie 93-103) oraz [app/api/webhooks/p24/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/webhooks/p24/route.ts)
*   **Problem:** P24 wymaga JSON bez znak贸w ucieczki dla "slashy" i unicode. Standardowy `JSON.stringify` dodaje te znaki, co powoduje generowanie bdnej sumy kontrolnej (sign).
*   **Wpyw:** Odrzucenie patnoci przez P24 lub odrzucenie wiarygodnych webhook贸w (bd weryfikacji podpisu).
*   **Zgodno ze specyfikacj:** Pkt 13.5 Webhook - "Weryfikacja podpisu (zgodnie z dokumentacj operatora)". To krytyczne dla dziaania patnoci.
*   **Rekomendacja:** Implementacja funkcji serializujcej JSON bez escape'owania, zgodnie z dokumentacj P24.

### 3. Walidacja podpisu i statusu P24 przed parsowaniem
*   **Plik:** [app/api/payments/create/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/payments/create/route.ts) (linie 149-167)
*   **Problem:** Kod parsuje odpowied藕 z P24 (`json()`) bez sprawdzenia statusu HTTP. W przypadku bdu (np. 500, 400) odpowied藕 mo偶e nie by JSON-em, co spowoduje wyjtek i brak obsu偶onego bdu.
*   **Rekomendacja:** Sprawdzenie `p24Response.ok` przed pr贸b odczytu body.

### 4. Zabezpieczenie link贸w zewntrznych (`rel="noopener noreferrer"`)
*   **Plik:** [app/components/add-offer-form.tsx](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/components/add-offer-form.tsx) (linie 489-495)
*   **Problem:** Linki do regulaminu otwierane w nowym oknie (`target="_blank"`) nie maj atrybutu `rel="noopener noreferrer"`.
*   **Wpyw:** Ryzyko bezpieczestwa (reverse tabnabbing).
*   **Rekomendacja:** Dodanie brakujcego atrybutu.

### 5. Brak walidacji hasha telefonu (Mo偶liwy Null)
*   **Plik:** [app/api/webhooks/p24/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/webhooks/p24/route.ts) (linie 94-104) oraz [actions/user/activate-offer.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/actions/user/activate-offer.ts)
*   **Problem:** Funkcja `normalizeAndHashPhone` jest wywoywana na potencjalnie pustej wartoci `phone_contact`, a wynik (hash) jest u偶ywany bez sprawdzenia czy jest poprawny/niepusty.
*   **Wpyw:** Bd w logice "1 darmowe ogoszenie na numer" (Pkt 42 specyfikacji). Jeli hash bdzie pusty lub bdny, mechanizm darmowego limitu mo偶e nie zadziaa lub zablokowa niewaciwych u偶ytkownik贸w.
*   **Rekomendacja:** Dodanie `guard clause` - sprawdzenie czy numer istnieje i czy wygenerowany hash jest poprawny przed zapisem do bazy.

## 锔 Stabilno i Logika

### 6. Brak walidacji `NEXT_PUBLIC_APP_URL`
*   **Plik:** [app/api/recover-magic-link/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/recover-magic-link/route.ts), [app/api/cron/route.tsx](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/cron/route.tsx)
*   **Problem:** Kod u偶ywa zmiennej rodowiskowej bez sprawdzenia czy istnieje. W przypadku jej braku (np. bd konfiguracji prod), generowane linki bd niepoprawne (`undefined/...`) lub w cronie fallbackuj do `localhost`, co na produkcji jest bdem.
*   **Wpyw:** Niedziaajce Magic Linki (Pkt 10 specyfikacji) - u偶ytkownicy nie bd mogli zarzdza ogoszeniami.
*   **Rekomendacja:** Dodanie walidacji zmiennej rodowiskowej przy starcie lub przy u偶yciu, z logowaniem bdu krytycznego w przypadku braku na produkcji.

### 7. Obsuga bd贸w przy normalizacji telefonu w Magic Link
*   **Plik:** [app/api/recover-magic-link/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/recover-magic-link/route.ts) (linie 5-7)
*   **Problem:** Brak `try/catch` przy parsowaniu JSON i normalizacji telefonu. Ze dane wejciowe spowoduj bd 500 zamiast kontrolowanej odmowy.
*   **Rekomendacja:** Opakowanie w blok `try/catch` i zwracanie generycznego bdu (by nie wycieka informacji).

### 8. Ignorowanie bd贸w zapisu w `check-free-slot` i `activate-offer`
*   **Pliki:** [app/api/check-free-slot/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/check-free-slot/route.ts), [actions/user/activate-offer.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/actions/user/activate-offer.ts)
*   **Problem:**
    *   W `check-free-slot`: u偶ycie `.single()` na bazie danych mo偶e rzuci bd inny ni偶 "brak wynik贸w", kt贸ry jest ignorowany.
    *   W `activate-offer`: bd aktualizacji tabeli `phone_hashes` jest ignorowany.
*   **Wpyw:** Niesp贸jno danych (np. u偶ytkownik wykorzysta darmowy slot, ale system tego nie odnotowa przez bd bazy).
*   **Rekomendacja:** Jawna obsuga bd贸w zwracanych przez Supabase.

### 9. Typowanie bdu P24
*   **Plik:** [app/api/payments/create/route.ts](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/api/payments/create/route.ts) (linie 173-179)
*   **Problem:** Pr贸ba zapisu obiektu bdu bezporednio do kolumny tekstowej bazy danych. Mo偶e to zapisa `[object Object]` zamiast treci bdu.
*   **Rekomendacja:** Serializacja obiektu bdu do stringa (`JSON.stringify`) przed zapisem.

### 10. Przekierowanie patnoci (Router vs Window)
*   **Plik:** [app/components/add-offer-form.tsx](file:///Users/tymonjezionek/Desktop/freelnace_wb/projekty/korepetycje_marketplace/app/app/components/add-offer-form.tsx) (linie 183-184)
*   **Problem:** U偶ycie `router.push` (nawigacja SPA) do przekierowania na zewntrzny URL patnoci (P24).
*   **Wpyw:** Problemy z przekierowaniem do bramki patnoci.
*   **Rekomendacja:** U偶ycie `window.location.href` dla zewntrznych URLi.
